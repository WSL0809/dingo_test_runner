# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is `dingo_test_runner`, a Rust-based MySQL test runner compatible with MySQL's official test format. The project supports parsing and executing `.test` files, result comparison, concurrent execution, and multiple report formats.

## Key Architecture

The system uses a layered architecture:

```
CLI � Loader � Parser (Pest) � Tester � Database � Reports
```

Core modules:
- **CLI layer** (`cli.rs`): Command-line argument parsing and input format resolution
- **Loader** (`loader.rs`): Test file discovery and loading from `t/` directory
- **Parser** (`tester/pest_parser.rs`): Pest-based syntax parser using `mysql_test.pest` grammar
- **Tester** (`tester/tester.rs`): Core test execution engine with serial and concurrent support
- **Database** (`tester/database.rs`): MySQL/SQLite abstraction with connection management
- **Reports** (`report/`): Multi-format reporting (Terminal, HTML, JUnit XML, Allure)

## Build Commands

```bash
# Build project
cargo build

# Release build
cargo build --release

# Run tests (Rust unit tests)
cargo test
```

## Core Usage Commands

### Basic Test Execution
```bash
# Run single test by name (searches t/<name>.test)
cargo run -- basic_test

# Run specific test file
cargo run -- t/basic_test.test

# Run all tests in directory
cargo run -- t/demo_tests/

# Run all tests
cargo run -- --all
```

### Database Connection
```bash
# Default connection (127.0.0.1:3306, root user)
cargo run -- test_name

# Custom connection
cargo run -- --host 127.0.0.1 --port 3306 --user root --passwd password test_name
```

### Record vs Compare Modes
```bash
# Record mode: Generate expected results (creates r/<test>.result)
cargo run -- --record test_name

# Compare mode: Validate against expected results (default)
cargo run -- test_name
```

### Parallel Execution
```bash
# File-level concurrency (NEW FEATURE)
cargo run -- --parallel 4 test1 test2 test3 test4

# Serial execution (default, backward compatible)
cargo run -- test1 test2 test3
```

### Reporting Formats
```bash
# Terminal output (default)
cargo run -- --report-format terminal test_name

# HTML report
cargo run -- --report-format html test_name

# JUnit XML for CI/CD
cargo run -- --report-format xunit --xunit-file report.xml test_name

# Allure enterprise reporting
cargo run -- --report-format allure --allure-dir ./allure-results test_name
```

## Test File Structure

- `t/` - Main test directory with `.test` files
- `t_for_test/` - Categorized test structure (basic/, variables/, control_flow/, etc.)
- `t/include/` - Include files (`.inc`) for `--source` functionality
- `r/` - Expected result files (`.result`) generated by `--record` mode

## Supported Test Language Features

The test format supports 48+ query types and directives:

- **Basic SQL**: Standard SQL queries and statements
- **Variables**: `let $var = value` and `$var` expansion, including SQL backtick expressions
- **Control flow**: `if ($condition)` / `while ($condition)` / `end` statements
- **Concurrency**: `--BEGIN_CONCURRENT` / `--END_CONCURRENT` blocks
- **Output control**: `--echo`, `--sorted_result`, `--replace_regex`
- **Error handling**: `--error <code>` for expected errors
- **File inclusion**: `--source <file>` for modular test scripts
- **Connection management**: `--connect` / `--disconnect`
- **System commands**: `--exec <command>`

## Debugging and Development

### Log Levels
```bash
# Debug logging
RUST_LOG=debug cargo run -- test_name

# Trace logging for parser
RUST_LOG=dingo_test_runner::tester::pest_parser=debug cargo run -- test_name

# Full trace
RUST_LOG=trace cargo run -- test_name
```

### Script Tools
```bash
# Run categorized tests
./run_categorized_tests.sh --help
./run_categorized_tests.sh basic variables

# Reorganize test structure
./reorganize_tests.sh
```

## Key Implementation Notes

- **Pest Parser**: Uses `src/tester/mysql_test.pest` grammar file for parsing
- **Connection Pooling**: Automatic connection management with configurable `--max-connections`
- **Database Isolation**: File-level concurrency uses temporary databases (`test_{name}_{thread}_{timestamp}_{pid}`)
- **Variable System**: Full variable expansion with expression evaluation support
- **Backward Compatibility**: All existing functionality preserved when adding new features

## Test Development Workflow

1. Create test file in `t/` directory
2. Generate expected results: `cargo run -- --record test_name`
3. Validate test passes: `cargo run -- test_name`
4. For categorized tests, use `t_for_test/` structure

## Common Issues

- If test fails with "Result file not found", run with `--record` first
- For database connection issues, verify MySQL service and connection parameters
- For concurrent execution issues, check database connection limits and reduce `--parallel` value

## Development Guidelines

- 新的修改不要影响原有功能

## Local Test Environment

- 本地 MySQL 配置：用户名 root，密码 123456，端口 3306